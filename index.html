<html>

<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .bar {
            fill: rgba(225, 225, 77, 0.842);
        }

        .axis text {
            font-size: 8px;
        }

        .bar-flavor {
            fill: rgba(77, 175, 242, 0.842);
        }

        .bar-texture {
            fill: rgba(100, 200, 0, 0.8);
        }
    </style>
</head>

<body>
    <h1>Number of Cheese Types and Flavors by Country</h1>
    <svg width="6000" height="600"></svg>
    <script>

        let width = 1500;
        let height = 600;
        const margin = { top: 20, right: 30, bottom: 70, left: 40 };
        const chartWidth = width - margin.left - margin.right;
        const chartHeight = height - margin.top - margin.bottom;


        const svg = d3.select("svg")
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);


        d3.json('cheeses.json').then(data => {

            const filteredData = data.filter(d => d.country && d.type && d.country && d.flavor !== 'NA' && d.type !== 'NA' && d.flavor !== 'NA' && d.texture !== 'NA');
            const aggregatedData = filteredData.map(d => {

                if (d.country.includes("United Kingdom") || d.country.includes("Great Britain") || d.country.includes("England")) {
                    d.country = "United Kingdom";
                }
                if (d.country.includes("Syria") || d.country.includes("Armenia") || d.country.includes("Turkey") || d.country.includes("Iraq") || d.country.includes("Afghanistan") || d.country.includes("Cyprus") || d.country.includes("Israel") || d.country.includes("Lebanon")) {
                    d.country = "Middle East";
                }
                if (d.country.includes("Italy")) {
                    d.country = "Italy";
                }
                if (d.country.includes("France")) {
                    d.country = "France";
                }
                if (d.country.includes("India")) {
                    d.country = "India";
                }
                if (d.country.includes("Scotland")) {
                    d.country = "United Kingdom";
                }

                if (d.country.includes("United States")) {
                    d.country = "United States";
                }
                if (d.country.includes("Sweden")) {
                    d.country = "Sweden";
                }
                if (d.country.includes("Georgia")) {
                    d.country = "United States";
                }
                if (d.country.includes("Netherlands")) {
                    d.country = "Netherlands";
                }
                if (d.country.includes("Slovakia")) {
                    d.country = "Slovakia";
                }
                if (d.country.includes("Mexico")) {
                    d.country = "Mexico";
                }
                if (d.country.includes("Wales")) {
                    d.country = "Wales";
                }
                if (d.country.includes("Germany")) {
                    d.country = "Germany";
                }
                if (d.country.includes("China") || d.country.includes("Tibet") || d.country.includes("Nepal") || d.country.includes("Mongolia")) {
                    d.country = "East Asia";
                }
                if (d.country.includes("New Zealand") || d.country.includes("Australia")) {
                    d.country = "Oceania";
                }
                return d;

            });
            const countryData = d3.rollups(aggregatedData, v => v.length, d => d.country)
                .map(([country, count]) => ({ country, count }));

            const flavorData = d3.rollups(aggregatedData, v => new Set(v.map(d => d.flavor)).size, d => d.country)
                .map(([country, flavorCount]) => ({ country, flavorCount }));

            // make sure to split by commas and spaces after
            const textureData = d3.rollups(aggregatedData, v => {
                const allTextures = v.flatMap(d => d.texture.split(',').map(flavor => flavor.trim()));
                return new Set(allTextures).size;
            },
                d => d.country
            )
                .map(([country, textureCount]) => ({ country, textureCount }));

            // Merge cheese count and flavor count data
            const mergedData = countryData.map(d => {
                const flavorObj = flavorData.find(f => f.country === d.country) || { flavorCount: 0 };
                const textureObj = textureData.find(f => f.country === d.country) || { textureCount: 0 };
                return { country: d.country, typeCount: d.count, flavorCount: flavorObj.flavorCount, textureCount: textureObj.textureCount };
            });

            const xScale = d3.scaleBand()
                .domain(mergedData.map(d => d.country))
                .range([0, chartWidth])
                .padding(0.1);

            const yScale = d3.scaleLinear()
                .domain([0, d3.max(mergedData, d => (d.typeCount, d.flavorCount, d.textureCount))])
                .range([chartHeight, 0]);

            const xSubgroup = d3.scaleBand()
                .domain(['typeCount', 'flavorCount', 'textureCount'])
                .range([0, xScale.bandwidth()])
                .padding(0.05);

            const color = d3.scaleOrdinal()
                .domain(['typeCount', 'flavorCount', 'textureCount'])
                .range(['rgba(225, 225, 77, 0.842)', 'rgba(77, 175, 242, 0.842)', 'rgba(100, 200, 0, 0.8)']);

            let leftAxis = d3.axisLeft(yScale);
            let bottomAxis = d3.axisBottom(xScale)


            svg.append("g")
                .attr("transform", `translate(0, ${chartHeight})`)
                .call(bottomAxis)
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            svg.append("g")
                .call(leftAxis);

            svg.append("g")
                .selectAll("g")
                .data(mergedData)
                .join("g")
                .attr("transform", d => `translate(${xScale(d.country)},0)`)
                .selectAll("rect")
                .data(d => ['typeCount', 'flavorCount', 'textureCount'].map(key => ({ key: key, value: d[key] })))
                .join("rect")
                .attr("x", d => xSubgroup(d.key))
                .attr("y", d => yScale(d.value))
                .attr("width", xSubgroup.bandwidth())
                .attr("height", d => chartHeight - yScale(d.value))
                .attr("fill", d => color(d.key));
        });
    </script>
</body>

</html>